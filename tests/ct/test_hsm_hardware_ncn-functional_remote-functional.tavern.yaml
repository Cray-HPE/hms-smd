# Copyright 2019-2020 Hewlett Packard Enterprise Development LP

# Tavern test cases for the Hardware State Manager (HSM) hardware API.
# Author: Mitch Schooler, Isa Wazirzada
# Service: Hardware State Manager

# HMS test metrics test cases: 12
# 1. GET /Hardware API response code
# 2. GET /HardwareByFRU API response code
# 3. GET /Hardware/{xname} node API response code
# 4. GET /Hardware/{xname} node API response body
# 5. GET /HardwareByFRU/{fruid} node API response code
# 6. GET /HardwareByFRU/{fruid} node API response body
# 7. GET /Hardware/{xname} node enclosure API response code
# 8. GET /Hardware/{xname} node enclosure API response body
# 9. GET /HardwareByFRU/{fruid} node enclosure API response code
# 10. GET /HardwareByFRU/{fruid} node enclosure API response body
# 11. Disabled (CASMHMS-2809) - GET /Hardware/{xname}p0 processor API response code
# 12. Disabled (CASMHMS-2809) - GET /Hardware/{xname}p0 processor API response body
# 13. Disabled (CASMHMS-2809) - GET /HardwareByFRU/{fruid} processor API response code
# 14. Disabled (CASMHMS-2809) - GET /HardwareByFRU/{fruid} processor API response body
# 15. Disabled (CASMHMS-2809) - GET /Hardware/{xname}d0 dimm API response code
# 16. Disabled (CASMHMS-2809) - GET /Hardware/{xname}d0 dimm API response body
# 17. Disabled (CASMHMS-2809) - GET /HardwareByFRU/{fruid} dimm API response code
# 18. Disabled (CASMHMS-2809) - GET /HardwareByFRU/{fruid} dimm API response body
# 19. GET /Hardware/Query/{xname} node API response code
# 20. GET /Hardware/Query/{xname} node API response body
---
test_name: Query the Hardware collection

stages:
  # 1. GET /Hardware API response code
  - name: Retrieve the hardware information from the Hardware collection
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/Hardware"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200

---
test_name: Query the HardwareByFRU collection

stages:
  # 2. GET /HardwareByFRU API response code
  - name: Retrieve the hardware information from the HardwareByFRU collection
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/HardwareByFRU"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200

---
test_name: Query the Hardware collection for Node information

stages:
  - name: Retrieve a node xname from the Components collection to use in the next stage
    request:
      url: "{base_url}/smd/hsm/v1/State/Components?type=Node"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      save:
        body:
          node_xname: Components.0.ID

  # 3. GET /Hardware/{xname} node API response code
  # 4. GET /Hardware/{xname} node API response body
  - name: Retrieve the hardware information for a given node xname from the Hardware collection
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/Hardware/{node_xname}"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      body:
        HWInventoryByLocationType: "HWInvByLocNode"
        ID: "{node_xname}"
        NodeLocationInfo:
          Description: !anystr
          HostName: !anystr
          Id: !anystr
          MemorySummary:
            TotalSystemMemoryGiB: !anyint
          Name: !anystr
          ProcessorSummary:
            Count: !anyint
            Model: !anystr
        Ordinal: !anyint
        PopulatedFRU:
          FRUID: !anystr
          HWInventoryByFRUType: "HWInvByFRUNode"
          NodeFRUInfo:
            AssetTag: !anystr
            BiosVersion: !anystr
            Manufacturer: !anystr
            Model: !anystr
            PartNumber: !anystr
            SKU: !anystr
            SerialNumber: !anystr
            SystemType: !anystr
            UUID: !anystr
          Subtype: !anystr
          Type: "Node"
        Status: !anystr
        Type: "Node"
      save:
        body:
          FRUID: PopulatedFRU.FRUID

  # 5. GET /HardwareByFRU/{fruid} node API response code
  # 6. GET /HardwareByFRU/{fruid} node API response body
  - name: Retrieve the FRU information for a given node FRUID from the HardwareByFRU collection
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/HardwareByFRU/{FRUID}"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      body:
        FRUID: "{FRUID}"
        HWInventoryByFRUType: "HWInvByFRUNode"
        NodeFRUInfo:
          AssetTag: !anystr
          BiosVersion: !anystr
          Manufacturer: !anystr
          Model: !anystr
          PartNumber: !anystr
          SKU: !anystr
          SerialNumber: !anystr
          SystemType: !anystr
          UUID: !anystr
        Subtype: !anystr
        Type: "Node"
        
---
test_name: Query the Hardware collection for Node Enclosure information

stages:
  - name: Retrieve a node enclosure xname from the Components collection to use in the next stage
    request:
      url: "{base_url}/smd/hsm/v1/State/Components?type=NodeEnclosure"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      save:
        body:
          node_enclosure_xname: Components.0.ID

  # 7. GET /Hardware/{xname} node enclosure API response code
  # 8. GET /Hardware/{xname} node enclosure API response body
  - name: Retrieve the hardware information for a given node enclosure xname from the Hardware collection
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/Hardware/{node_enclosure_xname}"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      body:
        HWInventoryByLocationType: "HWInvByLocNodeEnclosure"
        ID: "{node_enclosure_xname}"
        NodeEnclosureLocationInfo:
          Description: !anystr
          HostName: !anystr
          Id: !anystr
          Name: !anystr
        Ordinal: !anyint
        PopulatedFRU:
          FRUID: !anystr
          HWInventoryByFRUType: "HWInvByFRUNodeEnclosure"
          NodeEnclosureFRUInfo:
            AssetTag: !anystr
            ChassisType: !anystr
            Manufacturer: !anystr
            Model: !anystr
            PartNumber: !anystr
            SKU: !anystr
            SerialNumber: !anystr
          Subtype: !anything
          Type: "NodeEnclosure"
        Status: !anystr
        Type: "NodeEnclosure"
      save:
        body:
          FRUID: PopulatedFRU.FRUID

  # 9. GET /HardwareByFRU/{fruid} node enclosure API response code
  # 10. GET /HardwareByFRU/{fruid} node enclosure API response body
  - name: Retrieve the FRU information for a given node enclosure FRUID from the HardwareByFRU collection
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/HardwareByFRU/{FRUID}"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      body:
        FRUID: "{FRUID}"
        HWInventoryByFRUType: "HWInvByFRUNodeEnclosure"
        NodeEnclosureFRUInfo:
          AssetTag: !anystr
          ChassisType: !anystr
          Manufacturer: !anystr
          Model: !anystr
          PartNumber: !anystr
          SKU: !anystr
          SerialNumber: !anystr
        Subtype: !anystr
        Type: "NodeEnclosure"

#---
#
## The following test cases assume that a processor exists for {node_xname} with xname {node_xname}p0
## since processor xnames are not included in /State/Component queries and cannot be extracted
#test_name: Query the Hardware collection for Node Processor information
#
#stages:
#  - name: Retrieve a node xname from the Components collection to use in the next stage
#    request:
#      url: "{base_url}/smd/hsm/v1/State/Components?type=Node"
#      method: GET
#      headers:
#        Authorization: "Bearer {access_token}"
#      verify: !bool "{verify}"
#    response:
#      status_code: 200
#      save:
#        body:
#          node_xname: Components.0.ID
#
#  # 11. Disabled (CASMHMS-2809) - GET /Hardware/{xname}p0 processor API response code
#  # 12. Disabled (CASMHMS-2809) - GET /Hardware/{xname}p0 processor API response body
#  - name: Retrieve the hardware information for a given node processor xname from the Hardware collection
#    request:
#      url: "{base_url}/smd/hsm/v1/Inventory/Hardware/{node_xname}p0"
#      method: GET
#      headers:
#        Authorization: "Bearer {access_token}"
#      verify: !bool "{verify}"
#    response:
#      status_code: 200
#      body:
#        HWInventoryByLocationType: "HWInvByLocProcessor"
#        ID: "{node_xname}p0"
#        Ordinal: !anyint
#        PopulatedFRU:
#          FRUID: "FRUIDfor{node_xname}p0"
#          HWInventoryByFRUType: "HWInvByFRUProcessor"
#          ProcessorFRUInfo:
#            InstructionSet: !anystr
#            Manufacturer: !anystr
#            MaxSpeedMHz: !anyint
#            Model: !anystr
#            ProcessorArchitecture: !anystr
#            ProcessorId:
#              EffectiveFamily: !anystr
#              EffectiveModel: !anystr
#              IdentificationRegisters: !anystr
#              MicrocodeInfo: !anystr
#              Step: !anystr
#              VendorID: !anystr
#            ProcessorType: "CPU"
#            TotalCores: !anyint
#            TotalThreads: !anyint
#          Subtype: !anystr
#          Type: "Processor"
#        ProcessorLocationInfo:
#          Description: !anystr
#          Id: !anystr
#          Name: !anystr
#          Socket: !anystr
#        Status: !anystr
#        Type: "Processor"
#      save:
#        body:
#          FRUID: PopulatedFRU.FRUID
#
#  # 13. Disabled (CASMHMS-2809) - GET /HardwareByFRU/{fruid} processor API response code
#  # 14. Disabled (CASMHMS-2809) - GET /HardwareByFRU/{fruid} processor API response body
#  - name: Retrieve the FRU information for a given node processor FRUID from the HardwareByFRU collection
#    request:
#      url: "{base_url}/smd/hsm/v1/Inventory/HardwareByFRU/{FRUID}"
#      method: GET
#      headers:
#        Authorization: "Bearer {access_token}"
#      verify: !bool "{verify}"
#    response:
#      status_code: 200
#      body:
#        FRUID: "{FRUID}"
#        HWInventoryByFRUType: "HWInvByFRUProcessor"
#        ProcessorFRUInfo:
#          InstructionSet: !anystr
#          Manufacturer: !anystr
#          MaxSpeedMHz: !anyint
#          Model: !anystr
#          ProcessorArchitecture: !anystr
#          ProcessorId:
#            EffectiveFamily: !anystr
#            EffectiveModel: !anystr
#            IdentificationRegisters: !anystr
#            MicrocodeInfo: !anystr
#            Step: !anystr
#            VendorID: !anystr
#          ProcessorType: "CPU"
#          TotalCores: !anyint
#          TotalThreads: !anyint
#        Subtype: !anystr
#        Type: "Processor"
#
#---
#
## The following test cases assume that a memory dimm exists for {node_xname} with xname {node_xname}d0
## since memory dimm xnames are not included in /State/Component queries and cannot be extracted
#test_name: Query the Hardware collection for Node Memory information
#
#stages:
#  - name: Retrieve a node xname from the Components collection to use in the next stage
#    request:
#      url: "{base_url}/smd/hsm/v1/State/Components?type=Node"
#      method: GET
#      headers:
#        Authorization: "Bearer {access_token}"
#      verify: !bool "{verify}"
#    response:
#      status_code: 200
#      save:
#        body:
#          node_xname: Components.0.ID
#
#  # 15. Disabled (CASMHMS-2809) - GET /Hardware/{xname}d0 dimm API response code
#  # 16. Disabled (CASMHMS-2809) - GET /Hardware/{xname}d0 dimm API response body
#  - name: Retrieve the hardware information for a given node memory dimm xname from the Hardware collection
#    request:
#      url: "{base_url}/smd/hsm/v1/Inventory/Hardware/{node_xname}d0"
#      method: GET
#      headers:
#        Authorization: "Bearer {access_token}"
#      verify: !bool "{verify}"
#    response:
#      status_code: 200
#      body:
#        HWInventoryByLocationType: "HWInvByLocMemory"
#        ID: "{node_xname}d0"
#        MemoryLocationInfo:
#          Description: !anystr
#          Id: !anystr
#          MemoryLocation:
#            Channel: !anyint
#            MemoryController: !anyint
#            Slot: !anyint
#            Socket: !anyint
#          Name: !anystr
#        Ordinal: !anyint
#        PopulatedFRU:
#          FRUID: "FRUIDfor{node_xname}d0"
#          HWInventoryByFRUType: "HWInvByFRUMemory"
#          MemoryFRUInfo:
#            BaseModuleType: !anystr
#            BusWidthBits: !anyint
#            CapacityMiB: !anyint
#            DataWidthBits: !anyint
#            ErrorCorrection: !anystr
#            Manufacturer: !anystr
#            MemoryDeviceType: !anystr
#            MemoryType: "DRAM"
#            OperatingSpeedMhz: !anyint
#            PartNumber: !anystr
#            RankCount: !anyint
#            SerialNumber: !anystr
#          Subtype: !anystr
#          Type: "Memory"
#        Status: !anystr
#        Type: "Memory"
#      save:
#        body:
#          FRUID: PopulatedFRU.FRUID
#
#  # 17. Disabled (CASMHMS-2809) - GET /HardwareByFRU/{fruid} dimm API response code
#  # 18. Disabled (CASMHMS-2809) - GET /HardwareByFRU/{fruid} dimm API response body
#  - name: Retrieve the FRU information for a given node memory dimm FRUID from the HardwareByFRU collection
#    request:
#      url: "{base_url}/smd/hsm/v1/Inventory/HardwareByFRU/{FRUID}"
#      method: GET
#      headers:
#        Authorization: "Bearer {access_token}"
#      verify: !bool "{verify}"
#    response:
#      status_code: 200
#      body:
#        FRUID: "{FRUID}"
#        HWInventoryByFRUType: "HWInvByFRUMemory"
#        MemoryFRUInfo:
#          BaseModuleType: !anystr
#          BusWidthBits: !anyint
#          CapacityMiB: !anyint
#          DataWidthBits: !anyint
#          ErrorCorrection: !anystr
#          Manufacturer: !anystr
#          MemoryDeviceType: !anystr
#          MemoryType: "DRAM"
#          OperatingSpeedMhz: !anyint
#          PartNumber: !anystr
#          RankCount: !anyint
#          SerialNumber: !anystr
#        Subtype: !anystr
#        Type: "Memory"
#
---
test_name: Call the Hardware Inventory Query API with a Node xname

stages:
  - name: Retrieve a node xname from the Components collection to use in the next stage
    request:
      url: "{base_url}/smd/hsm/v1/State/Components?type=Node"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      save:
        body:
          node_xname: Components.0.ID

  # 19. GET /Hardware/Query/{xname} node API response code
  # 20. GET /Hardware/Query/{xname} node API response body
  - name: Retrieve the hardware information for a given node xname from the Hardware Query collection
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/Hardware/Query/{node_xname}"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      body:
        Format: "NestNodesOnly"
        Nodes:
          -
            HWInventoryByLocationType: "HWInvByLocNode"
            ID: "{node_xname}"
            NodeLocationInfo:
              Description: !anystr
              HostName: !anystr
              Id: !anystr
              MemorySummary:
                TotalSystemMemoryGiB: !anyint
              Name: !anystr
              ProcessorSummary:
                Count: !anyint
                Model: !anystr
            Ordinal: !anyint
            PopulatedFRU:
              FRUID: !anystr
              HWInventoryByFRUType: "HWInvByFRUNode"
              NodeFRUInfo:
                AssetTag: !anystr
                BiosVersion: !anystr
                Manufacturer: !anystr
                Model: !anystr
                PartNumber: !anystr
                SKU: !anystr
                SerialNumber: !anystr
                SystemType: !anystr
                UUID: !anystr
              Subtype: !anystr
              Type: "Node"
            Status: "Populated"
            Type: "Node"
        XName: "{node_xname}"
