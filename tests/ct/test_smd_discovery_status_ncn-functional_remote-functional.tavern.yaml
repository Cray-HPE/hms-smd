# Copyright 2019-2020 Hewlett Packard Enterprise Development LP

# Tavern test cases for the Hardware State Manager (HSM) discovery status API.
# Author: Mitch Schooler
# Service: Hardware State Manager

# HMS test metrics test cases: 4
# 1. GET /DiscoveryStatus API response code
# 2. GET /DiscoveryStatus API response body
# 3. GET /DiscoveryStatus/{xname} API response code
# 4. GET /DiscoveryStatus/{xname} API response body
---
test_name: Ensure that we can gather the system discovery status information
# C02VF3KDHTD8:~ schooler$ curl -k https://squirt-sms.us.cray.com:30443/apis/smd/hsm/v1/Inventory/DiscoveryStatus 2> /dev/null | python -m json.tool
# [
#     {
#         "ID": 0,
#         "LastUpdateTime": "2019-06-26 03:07:06.000000",
#         "Status": "Complete"
#     }
# ]

stages:
  # 1. GET /DiscoveryStatus API response code
  # 2. GET /DiscoveryStatus API response body
  - name: Ensure that we can conduct a discovery status query
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/DiscoveryStatus"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      body:
        $ext:
          function: tavern.testutils.helpers:validate_pykwalify
          extra_kwargs:
            schema:
              type: seq
              matching: all
              sequence:
                - type: map
                  matching: all
                  mapping:
                    ID:
                      type: int
                    LastUpdateTime:
                      type: timestamp
                    Status:
                      type: str
                      pattern: "Complete"
      save:
        body:
          id: 0.ID

  # 3. GET /DiscoveryStatus/{xname} API response code
  # 4. GET /DiscoveryStatus/{xname} API response body
  - name: Get discovery status data for a single discovery instance using API endpoint
    request:
      url: "{base_url}/smd/hsm/v1/Inventory/DiscoveryStatus/{id}"
      method: GET
      headers:
        Authorization: "Bearer {access_token}"
      verify: !bool "{verify}"
    response:
      status_code: 200
      body:
        $ext:
          function: tavern.testutils.helpers:validate_pykwalify
          extra_kwargs:
            schema:
              type: map
              mapping:
                ID:
                  type: int
                  enum:
                    - !int "{id:d}"
                LastUpdateTime:
                  type: timestamp
                Status:
                  type: str
                  pattern: "Complete"
